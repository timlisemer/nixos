# Climate Control Automations
# Uses better_thermostat nightmode services and presence-based logic

# K端che & Wohnzimmer Heizung
- id: 'kuche_wohnzimmer_heizung'
  alias: 'K端che & Wohnzimmer Heizung'
  description: 'Control kitchen/living room heating based on presence, room activity, and time of day'
  triggers:
    - trigger: state
      entity_id:
        - binary_sensor.somebody_home
        - binary_sensor.tim_home
        - binary_sensor.edith_home
        - binary_sensor.kuche_wohnzimmer_in_use
        - binary_sensor.wohnzimmer_kuche_daytime_heating_period
    - trigger: time_pattern
      hours: '/1'
  actions:
    - choose:
        # OPTION 1: Room active OR Edith home in schedule
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: binary_sensor.kuche_wohnzimmer_in_use
                  state: 'on'
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: binary_sensor.wohnzimmer_kuche_daytime_heating_period
                      state: 'on'
                    - condition: state
                      entity_id: binary_sensor.edith_home
                      state: 'on'
          sequence:
            # Exit nightmode
            - action: better_thermostat.restore_saved_target_temperature
              target:
                entity_id:
                  - climate.wohnzimmer_heizung
                  - climate.kuche_heizung
            # Set explicit temps
            - action: better_thermostat.set_temp_target_temperature
              target:
                entity_id: climate.wohnzimmer_heizung
              data:
                temperature: 22
            - action: better_thermostat.set_temp_target_temperature
              target:
                entity_id: climate.kuche_heizung
              data:
                temperature: 20

        # OPTION 2: Tim home (not Edith) in schedule
        - conditions:
            - condition: state
              entity_id: binary_sensor.wohnzimmer_kuche_daytime_heating_period
              state: 'on'
            - condition: state
              entity_id: binary_sensor.tim_home
              state: 'on'
            - condition: state
              entity_id: binary_sensor.edith_home
              state: 'off'
          sequence:
            # Exit nightmode
            - action: better_thermostat.restore_saved_target_temperature
              target:
                entity_id:
                  - climate.wohnzimmer_heizung
                  - climate.kuche_heizung
            # Set both to 20
            - action: better_thermostat.set_temp_target_temperature
              target:
                entity_id:
                  - climate.wohnzimmer_heizung
                  - climate.kuche_heizung
              data:
                temperature: 20

      # DEFAULT: Nightmode (nobody home or out of schedule)
      default:
        - action: better_thermostat.set_temp_target_temperature
          target:
            entity_id:
              - climate.wohnzimmer_heizung
              - climate.kuche_heizung
          data:
            temperature: 18
  mode: single

# Tim B端ro & Schlafzimmer Heizung
- id: 'tim_buro_schlafzimmer_heizung'
  alias: 'Tim B端ro & Schlafzimmer Heizung'
  description: "Control Tim's office/bedroom heating based on Tim's presence, room activity, and time of day"
  triggers:
    - trigger: state
      entity_id:
        - binary_sensor.tim_home
        - binary_sensor.buro_tim_schlafzimmer_in_use
        - binary_sensor.tim_daytime_heating_period
    - trigger: time_pattern
      hours: '/1'
  actions:
    - choose:
        # Room active OR Tim home in schedule
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: binary_sensor.buro_tim_schlafzimmer_in_use
                  state: 'on'
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: binary_sensor.tim_daytime_heating_period
                      state: 'on'
                    - condition: state
                      entity_id: binary_sensor.tim_home
                      state: 'on'
          sequence:
            # Exit nightmode
            - action: better_thermostat.restore_saved_target_temperature
              target:
                entity_id: climate.tim_buro_schlafzimmer_heizung
            # Set explicit temp
            - action: better_thermostat.set_temp_target_temperature
              target:
                entity_id: climate.tim_buro_schlafzimmer_heizung
              data:
                temperature: 22

      # DEFAULT: Nightmode
      default:
        - action: better_thermostat.set_temp_target_temperature
          target:
            entity_id: climate.tim_buro_schlafzimmer_heizung
          data:
            temperature: 18
  mode: single
